# 4 函数和变量声明

本章描述了如何声明函数、参数和变量。还详细说明了特性如何与函数、参数和变量一起使用来指定一些限制。

## 4.1 函数

> 所有操作系统：kernel、vetex和fragment属性从v1.0开始就支持。

Metal支持以下函数属性，这些属性限定了函数的使用方式：`vertex`、`fragment`和`kernel`，它们分别在4.1.1、4.1.2和4.1.3节中详述。这些函数属性在函数的开头使用，在返回值之前。

使用了`vertex`、`fragment`和`kernel`函数属性的函数不得调用也使用这些属性的函数，否则会导致编译错误。

可以在命名空间内声明使用`vertex`、`fragment`和`kernel`函数属性的函数。

### 4.1.1 顶点函数(Vertex Functions)

以下示例演示了使用`vertex`属性声明顶点函数的语法。

```metal
vertex void 
my_vertex_func(...) 
{...}
```

### 4.1.2 片段函数(Fragment Functions)

### 4.1.3 内核函数(Kernel Functions)

```metal
kernel void 
my_kernel(...) 
{...}
```

使用`kernel`属性声明的函数必须返回`void`。

` [[max_total_threads_per_threadgroup]]` 函数属性可以与内核函数一起使用，来指定每个线程组的最大线程数。

下面是使用此属性的内核函数示例：

```metal
[[max_total_threads_per_threadgroup(x)]]
kernel void
my_kernel(...)
{...}
```

如果`[[max_total_threads_per_threadgroup]]`的值大于`[MTLDevice maxThreadsPerThreadgroup]`属性，则管道状态会创建失败。

### 4.1.4 Tile函数



## 4.2 Address Space Attributes for Variables and Arguments

`device`、`threadgroup`、`constant` 和 `thread`

`threadgroup_imageblock`



* `device`
* `threadgroup`
* `threadgroup_imageblock` (section 4.2.3)
* `constant` (section 4.2.2)
* `thread` (section 4.2.5)

### 4.2.1 device Address Space

### 4.2.2 threadgroup Address Space

### 4.2.3 threadgroup_imageblock Address Space

### 4.2.4 constant Address Space

### 4.2.5 thread Address Space

## 4.3 函数参数与变量

大部分图像处理器和内核方法的输入和输出是通过参数来传递的。



### 4.3.2 Buffers 和 纹理的结构


## 4.4 存储类说明符

```metal
extern constant float4 noise_table[256];
static constant float4 color_table[256] = { ... }; // static is okay

extern void my_foo(texture2d<float> img);
extern void my_bar(device float *a);

kernel void
my_kernel(texture2d<float> img [[texture(0)]],
          device float *ptr [[buffer(0)]])
{
    extern constant float4 a; 
    static constant float4 b;  // static is an error. 
    static float c; // static is an error.

    ...
    my_foo(img);
    ...
    my_bar(ptr);
    ...
}
```

## 4.5 采样和差值属性

```metal
center_perspective
center_no_perspective
centroid_perspective
centroid_no_perspective
sample_perspective
sample_no_perspective
flat
```

`center_perspective`是默认的采样和差值属性，以下情况例外：

```metal
struct FragmentInput {
     float4 pos [[center_no_perspective]];
     float4 color [[center_perspective]];
     float2 texcoord;
     int index [[flat]];
     float f [[sample_perspective]];
};
```

## 4.12 附加限制

